<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Default to dark mode --><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKACHAI ADMIN PORTAL</title>
    <!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chart.js for graphs --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- EmailJS for sending emails --><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- QR Code Generator --><script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">


    <style>
        /* Light & Dark Mode Theme variables */
        :root {
            --bg-color: #F3F4F6; /* light: gray-100 */
            --text-color: #1F2937; /* light: gray-800 */
            --card-bg: #FFFFFF; /* light: white */
            --border-color: #D1D5DB; /* light: gray-300 */
            --input-bg: #F9FAFB; /* light: gray-50 */
            --primary-color: #D4AF37; 
            --gold-text: #D4AF37;
        }

        html.dark {
            --bg-color: #111827; /* dark: gray-900 */
            --text-color: #F9FAFB; /* dark: gray-50 */
            --card-bg: #1F2937; /* dark: gray-800 */
            --border-color: #4B5563; /* dark: gray-600 */
            --input-bg: #374151; /* dark: gray-700 */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .gold-text { color: var(--gold-text); }
        .bg-card { background-color: var(--card-bg); }
        .border-theme { border-color: var(--border-color); }
        .bg-input { background-color: var(--input-bg); }
        .bg-gold { background-color: var(--primary-color); }
        .hover-bg-gold-dark:hover { background-color: #b89b31; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--card-bg); }
        ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #b89b31; }

        .content-section { display: none; }
        .content-section.active { display: block; }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Sidebar styles */
        #sidebar.collapsed {
            width: 5rem; /* 80px */
        }
        #sidebar.collapsed .nav-text, #sidebar.collapsed .sidebar-title {
            display: none;
        }
        #sidebar.collapsed .nav-link {
            justify-content: center;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Loading Overlay --><div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
        <div class="loader"></div>
    </div>

    <!-- Login Section --><section id="login-section" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-card p-8 rounded-lg shadow-lg w-full max-w-md border border-theme">
             <img src="https://i.ibb.co/L519V3F/akachai-logo-transparent.png" alt="AKACHAI FC Logo" class="h-20 w-20 mx-auto mb-4 object-contain">
            <h1 class="text-3xl font-bold text-center gold-text mb-6">AKACHAI ADMIN PORTAL</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full p-3 bg-input rounded-md border border-theme focus:outline-none focus:ring-2 focus:ring-gold" required>
                </div>
                <div class="mb-4 relative">
                    <label for="password" class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="login-password" class="w-full p-3 bg-input rounded-md border border-theme focus:outline-none focus:ring-2 focus:ring-gold pr-10" required>
                    <span id="toggle-password" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-400" style="top: 1.875rem;">
                        <i class="fas fa-eye"></i>
                    </span>
                </div>
                 <div class="text-right mb-6">
                    <a href="#" id="forgot-password-link" class="text-sm text-yellow-400 hover:text-yellow-200 hover:underline">Forgot Password?</a>
                </div>
                <button type="submit" class="w-full bg-gold text-black font-bold py-3 rounded-md hover-bg-gold-dark transition-colors">Login</button>
            </form>
            <p id="login-error" class="text-red-500 text-center mt-4"></p>
        </div>
    </section>

    <!-- Main App Section --><main id="app-section" class="hidden">
        <div class="relative min-h-screen md:flex">
             <!-- Mobile overlay --><div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>
            <!-- Sidebar Navigation --><aside id="sidebar" class="w-64 bg-card fixed inset-y-0 left-0 p-4 border-r border-theme flex flex-col transform -translate-x-full md:relative md:translate-x-0 z-30 transition-all duration-300 ease-in-out">
                <div class="text-center mb-8">
                    <img src="https://i.ibb.co/L519V3F/akachai-logo-transparent.png" alt="AKACHAI FC Logo" class="h-16 w-16 mx-auto mb-2 object-contain">
                    <h2 class="text-2xl font-bold gold-text sidebar-title">Akachai FC</h2>
                </div>
                <nav id="main-nav" class="space-y-2 flex-grow">
                    <!-- Nav links will be injected by JS based on role --></nav>
                <div class="mt-auto">
                    <button id="sidebar-toggle-btn" class="w-full mb-2 text-gray-500 hover:text-gold-text py-2 px-4 rounded-md hidden md:block">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                     <button id="logout-btn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-sign-out-alt"></i><span class="nav-text">Logout</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content Area --><div id="main-content" class="flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto">
                <header class="flex justify-between items-center mb-8">
                     <button id="hamburger-btn" class="text-2xl md:hidden">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 id="page-title" class="text-3xl md:text-5xl font-extrabold gold-text">Dashboard</h1>
                    <div class="flex items-center gap-4">
                        <button id="theme-toggle-btn" class="text-2xl">
                           <i class="fas fa-sun"></i> <!-- Icon changes dynamically --></button>
                        <div class="relative">
                             <i class="fas fa-bell text-2xl cursor-pointer" id="notification-icon"></i>
                             <span id="notification-badge" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </div>
                        <div id="user-profile" class="text-right hidden sm:block">
                            <p class="font-semibold text-lg" id="user-name-display"></p>
                            <p class="text-sm text-gray-500 dark:text-gray-400" id="user-role-display"></p>
                        </div>
                    </div>
                </header>

                <!-- All content sections go here --><!-- Dashboard Content --><div id="dashboard-content" class="content-section active">
                    <h2 class="text-2xl font-semibold mb-4">Monthly Social Media Engagement</h2>
                    <div class="bg-card p-4 rounded-lg shadow-md border border-theme">
                        <canvas id="engagements-chart"></canvas>
                    </div>
                    <div id="admin-alerts-section" class="mt-8">
                        <h2 class="text-2xl font-semibold mb-4">Send Important Alert</h2>
                        <div class="bg-card p-4 rounded-lg shadow-md border border-theme">
                           <textarea id="alert-message" class="w-full p-3 bg-input rounded-md border border-theme" rows="3" placeholder="Type your alert message here..."></textarea>
                           <button id="send-alert-btn" class="mt-2 bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark">Send Alert</button>
                        </div>
                    </div>
                </div>

                <!-- Requisitions Content --><div id="requisitions-content" class="content-section">
                    <button id="new-requisition-btn" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark mb-4">New Requisition</button>
                    <div id="new-requisition-form-container" class="bg-card p-6 rounded-lg mb-6 hidden border border-theme">
                        <h3 class="text-xl font-bold mb-4">Requisition Form</h3>
                        <form id="requisition-form">
                             <input type="text" id="req-name" placeholder="Your Name" class="w-full p-2 mb-2 bg-input rounded" required>
                             <textarea id="req-reason" placeholder="Reason for Requisition" class="w-full p-2 mb-2 bg-input rounded" required></textarea>
                             <div id="req-items-container">
                                <div class="flex gap-2 mb-2 items-center">
                                    <input type="text" placeholder="Item Description" class="w-1/2 p-2 bg-input rounded req-item-desc" required>
                                    <input type="number" placeholder="Qty" class="w-1/6 p-2 bg-input rounded req-item-qty" required min="1" step="any">
                                    <input type="number" placeholder="Unit Price" class="w-1/4 p-2 bg-input rounded req-item-price" required min="0" step="any">
                                </div>
                             </div>
                             <button type="button" id="add-req-item-btn" class="text-sm bg-gray-500 dark:bg-gray-600 py-1 px-3 rounded hover:bg-gray-400 dark:hover:bg-gray-500 mb-4">Add Another Item</button>
                             <button type="submit" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark">Submit for Approval</button>
                        </form>
                    </div>
                    <h2 class="text-2xl font-semibold mb-4">Requisition History & Approvals</h2>
                    <div id="requisitions-list" class="space-y-4">
                        <!-- Requisition items will be dynamically added here --></div>
                </div>

                <!-- Finances Content --><div id="finances-content" class="content-section">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-card p-4 rounded-lg border border-theme">
                            <h3 class="text-lg font-bold text-green-500">Total Credit (Inflow)</h3>
                            <p id="total-inflow" class="text-3xl font-semibold">0.00</p>
                        </div>
                        <div class="bg-card p-4 rounded-lg border border-theme">
                            <h3 class="text-lg font-bold text-red-500">Total Debit (Outflow)</h3>
                            <p id="total-outflow" class="text-3xl font-semibold">0.00</p>
                        </div>
                    </div>
                    <div id="pending-transactions-section" class="mb-8">
                        <h2 class="text-2xl font-semibold mb-4">Pending Transactions for Approval</h2>
                        <div id="pending-transactions-list" class="space-y-4">
                            <!-- Pending transaction items will be dynamically added here --></div>
                    </div>
                     <div class="bg-card p-6 rounded-lg mb-6 border border-theme">
                        <h3 class="text-xl font-bold mb-4">Submit New Transaction for Approval</h3>
                        <form id="transaction-form" class="flex flex-wrap gap-4 items-end">
                            <div class="flex-grow">
                                <label>Description</label>
                                <input id="trans-desc" type="text" placeholder="e.g., Purchase of new balls" class="w-full p-2 bg-input rounded" required>
                            </div>
                            <div class="flex-grow">
                                <label>Amount</label>
                                <input id="trans-amount" type="number" placeholder="1000" class="w-full p-2 bg-input rounded" required min="0" step="any">
                            </div>
                            <div class="flex-grow">
                                <label>Type</label>
                                <select id="trans-type" class="w-full p-2 bg-input rounded">
                                    <option value="credit">Credit (Inflow)</option>
                                    <option value="debit">Debit (Outflow)</option>
                                </select>
                            </div>
                            <button type="submit" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark">Submit for Approval</button>
                        </form>
                    </div>
                    <h2 class="text-2xl font-semibold mb-4">Approved Transaction History</h2>
                    <div id="transactions-list" class="bg-card p-4 rounded-lg border border-theme">
                       <!-- transaction items will be added here --></div>
                </div>

                <!-- Receipt Issuance Content --><div id="receipts-content" class="content-section">
                    <h2 class="text-2xl font-semibold mb-4">Issue a New Receipt</h2>
                    <div class="bg-card p-6 rounded-lg border border-theme">
                        <form id="receipt-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label>Payer's Name</label>
                                    <input id="payer-name" type="text" class="w-full p-2 bg-input rounded" required>
                                </div>
                                <div>
                                    <label>Payer's Email</label>
                                    <input id="payer-email" type="email" class="w-full p-2 bg-input rounded" required>
                                </div>
                                <div>
                                    <label>Amount Paid</label>
                                    <input id="payment-amount" type="number" class="w-full p-2 bg-input rounded" required min="1" step="any">
                                </div>
                                <div>
                                    <label>Payment For</label>
                                    <input id="payment-purpose" type="text" placeholder="e.g., Club Membership" class="w-full p-2 bg-input rounded" required>
                                </div>
                            </div>
                            <button type="submit" class="mt-4 bg-gold text-black font-bold py-2 px-6 rounded-md hover-bg-gold-dark">Generate & Send Receipt</button>
                        </form>
                    </div>
                </div>

                <!-- Chat Room Content --><div id="chat-content" class="content-section">
                    <h2 class="text-2xl font-semibold mb-4">Club Chat Room</h2>
                    <div class="bg-card rounded-lg h-[70vh] flex flex-col border border-theme">
                        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
                            <!-- Chat messages will appear here --></div>
                        <div class="p-4 border-t border-theme">
                            <form id="chat-form" class="flex gap-2">
                                <input id="chat-input" type="text" placeholder="Type a message..." class="flex-1 p-2 bg-input rounded" required>
                                <button type="submit" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark">Send</button>
                            </form>
                        </div>
                    </div>
                </div>

                 <!-- User Management (Admin Only) --><div id="user-management-content" class="content-section">
                    <div class="bg-card p-6 rounded-lg mb-6 border border-theme">
                        <h3 class="text-xl font-bold mb-4">Add New User</h3>
                        <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div class="md:col-span-1">
                                <label>Full Name</label>
                                <input id="new-user-name" type="text" class="w-full p-2 bg-input rounded" required>
                            </div>
                            <div class="md:col-span-1">
                                <label>Email</label>
                                <input id="new-user-email" type="email" class="w-full p-2 bg-input rounded" required>
                            </div>
                            <div class="md:col-span-1">
                                <label>Role</label>
                                <select id="new-user-role" class="w-full p-2 bg-input rounded">
                                    <option value="user">General User</option>
                                    <option value="treasurer">Treasurer</option>
                                    <option value="president">President</option>
                                    <option value="admin">Admin</option>
                                    <option value="social_media_x">Social Media (X)</option>
                                    <option value="social_media_ig_main">Social Media (Instagram Main)</option>
                                    <option value="social_media_ig_fan">Social Media (Instagram Fan)</option>
                                    <option value="social_media_whatsapp">Social Media (WhatsApp)</option>
                                    <option value="social_media_tiktok">Social Media (TikTok)</option>
                                    <option value="treasury_staff">Treasury Staff</option>
                                </select>
                            </div>
                             <button type="submit" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark">Create User</button>
                        </form>
                        <p class="text-sm mt-2 text-gray-500 dark:text-gray-400">A password reset email will be sent to the new user.</p>
                    </div>
                    <h2 class="text-2xl font-semibold mb-4">Manage Users</h2>
                    <div id="users-list" class="bg-card p-4 rounded-lg border border-theme">
                        <!-- User list will appear here --></div>
                </div>

                <!-- Social Media Stats Content --><div id="social-media-content" class="content-section">
                    <h2 class="text-2xl font-semibold mb-4">Record Social Media Engagements for <span id="current-month-year"></span></h2>
                    <div class="bg-card p-6 rounded-lg border border-theme">
                        <form id="social-media-form">
                             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                 <div class="flex items-center gap-3">
                                    <i class="fab fa-twitter text-2xl w-6 text-center"></i>
                                    <div>
                                        <label for="engagement-x" class="font-semibold">X / Twitter Engagements</label>
                                        <input id="engagement-x" type="number" class="w-full p-2 bg-input rounded disabled:bg-gray-800 disabled:cursor-not-allowed" required min="0" step="1" placeholder="e.g., 1500" disabled>
                                    </div>
                                 </div>
                                 <div class="flex items-center gap-3">
                                    <i class="fab fa-instagram text-2xl w-6 text-center"></i>
                                    <div>
                                        <label for="engagement-ig-main" class="font-semibold">Instagram Main Engagements</label>
                                        <input id="engagement-ig-main" type="number" class="w-full p-2 bg-input rounded disabled:bg-gray-800 disabled:cursor-not-allowed" required min="0" step="1" placeholder="e.g., 5500" disabled>
                                    </div>
                                 </div>
                                 <div class="flex items-center gap-3">
                                     <i class="fab fa-instagram-square text-2xl w-6 text-center"></i>
                                     <div>
                                        <label for="engagement-ig-fan" class="font-semibold">Instagram Fan Engagements</label>
                                        <input id="engagement-ig-fan" type="number" class="w-full p-2 bg-input rounded disabled:bg-gray-800 disabled:cursor-not-allowed" required min="0" step="1" placeholder="e.g., 2300" disabled>
                                     </div>
                                 </div>
                                 <div class="flex items-center gap-3">
                                     <i class="fab fa-whatsapp text-2xl w-6 text-center"></i>
                                     <div>
                                        <label for="engagement-whatsapp" class="font-semibold">WhatsApp Engagements</label>
                                        <input id="engagement-whatsapp" type="number" class="w-full p-2 bg-input rounded disabled:bg-gray-800 disabled:cursor-not-allowed" required min="0" step="1" placeholder="e.g., 800" disabled>
                                     </div>
                                 </div>
                                 <div class="flex items-center gap-3">
                                     <i class="fab fa-tiktok text-2xl w-6 text-center"></i>
                                     <div>
                                        <label for="engagement-tiktok" class="font-semibold">TikTok Engagements</label>
                                        <input id="engagement-tiktok" type="number" class="w-full p-2 bg-input rounded disabled:bg-gray-800 disabled:cursor-not-allowed" required min="0" step="1" placeholder="e.g., 4200" disabled>
                                     </div>
                                 </div>
                             </div>
                              <button type="submit" class="mt-6 bg-gold text-black font-bold py-2 px-6 rounded-md hover-bg-gold-dark">Save Monthly Data</button>
                        </form>
                    </div>
                </div>

                <!-- Jersey Orders Content --><div id="jersey-orders-content" class="content-section">
                    <div class="bg-card p-6 rounded-lg mb-6 border border-theme">
                        <h3 class="text-xl font-bold mb-4">Add New Jersey Order</h3>
                        <form id="jersey-order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            <div>
                                <label>Customer Name</label>
                                <input id="customer-name" type="text" class="w-full p-2 bg-input rounded" required>
                            </div>
                            <div>
                                <label>Customer Email</label>
                                <input id="customer-email" type="email" class="w-full p-2 bg-input rounded" required>
                            </div>
                            <div>
                                <label>Phone Number</label>
                                <input id="customer-phone" type="tel" class="w-full p-2 bg-input rounded" required>
                            </div>
                             <div>
                                <label>Jersey Size</label>
                                <select id="jersey-size" class="w-full p-2 bg-input rounded">
                                    <option>Small</option>
                                    <option>Medium</option>
                                    <option>Large</option>
                                    <option>XL</option>
                                    <option>XXL</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label>Delivery Location</label>
                                <input id="delivery-location" type="text" class="w-full p-2 bg-input rounded" required placeholder="e.g., Club House, Main Gate">
                            </div>
                             <button type="submit" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark md:col-span-2">Place Order & Send Confirmation</button>
                        </form>
                    </div>
                    <h2 class="text-2xl font-semibold mb-4">Manage Jersey Orders</h2>
                    <div id="jersey-orders-list" class="bg-card p-4 rounded-lg border border-theme overflow-x-auto">
                        <!-- Jersey orders will be dynamically added here --></div>
                </div>

                <!-- Player Registration Content --><div id="player-registration-content" class="content-section">
                    <div class="bg-card p-6 rounded-lg mb-6 border border-theme">
                        <h3 class="text-xl font-bold mb-4">Register New Player</h3>
                        <form id="player-registration-form">
                            <!-- Player Details --><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label>Player's Full Name</label>
                                    <input id="player-name" type="text" class="w-full p-2 bg-input rounded" required>
                                </div>
                                <div>
                                    <label>Date of Birth</label>
                                    <input id="player-dob" type="date" class="w-full p-2 bg-input rounded" required>
                                </div>
                                <div>
                                    <label>Nationality</label>
                                    <input id="player-nationality" type="text" class="w-full p-2 bg-input rounded" required>
                                </div>
                                <div>
                                    <label>Position</label>
                                    <select id="player-position" class="w-full p-2 bg-input rounded">
                                        <option>Goalkeeper</option>
                                        <option>Defender</option>
                                        <option>Midfielder</option>
                                        <option>Forward</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Jersey Number</label>
                                    <input id="player-jersey" type="number" class="w-full p-2 bg-input rounded" min="1" max="99" required>
                                </div>
                            </div>
                            <button type="submit" class="mt-6 bg-gold text-black font-bold py-2 px-6 rounded-md hover-bg-gold-dark">Add Player</button>
                        </form>
                    </div>
                    <h2 class="text-2xl font-semibold mb-4">Player Game Week & Allowance Tracker</h2>
                    <div id="players-list" class="bg-card p-4 rounded-lg border border-theme overflow-x-auto">
                        <!-- Player list will be dynamically added here --></div>
                </div>

            </div>
        </div>
    </main>

    <!-- Firebase SDK --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            sendPasswordResetEmail,
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc,
            setDoc, 
            getDoc, 
            getDocs,
            updateDoc,
            deleteDoc,
            onSnapshot,
            query,
            orderBy,
            Timestamp,
            where,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- PLACEHOLDERS & CONFIG ---
        const providedFirebaseConfig = {
           apiKey: "AIzaSyCX1fbImBBmjz1nbVuwgAwWoQJRhP_eqFs",
           authDomain: "akachai-fc-records.firebaseapp.com",
           projectId: "akachai-fc-records",
           storageBucket: "akachai-fc-records.appspot.com",
           messagingSenderId: "368803590661",
           appId: "1:368803590661:web:ca7d0597f22e6bd40de26c"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : providedFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'akachai-fc-portal';

        // --- APP CONSTANTS ---
        const JERSEY_PRICE = 50000; // Price per jersey in UGX

        // --- EMAILJS CONFIG: Your actual credentials ---
        const EMAILJS_SERVICE_ID = "service_9nzfwtm";
        const EMAILJS_MASTER_TEMPLATE_ID = "template_2uv7tei"; 
        const EMAILJS_NEW_USER_TEMPLATE_ID = "template_lu4axsh"; 
        const EMAILJS_PUBLIC_KEY = "l3bB3ofE87AW5cFb2";


        // --- FIREBASE INITIALIZATION ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            emailjs.init(EMAILJS_PUBLIC_KEY);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="text-red-500 text-center p-8">Failed to initialize. Error: ${error.message}</div>`;
        }

        // --- GLOBAL STATE & UI ELEMENTS ---
        let currentUser = null;
        let currentUserRole = 'user';
        let engagementsChart = null;
        const loadingOverlay = document.getElementById('loading-overlay');
        let inactivityTimer;
        
        // --- INACTIVITY LOGOUT ---
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                showToast("You have been logged out due to inactivity.", true);
                signOut(auth);
            }, 20 * 60 * 1000); // 20 minutes
        }

        // --- THEME LOGIC ---
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const sunIcon = `<i class="fas fa-sun"></i>`;
        const moonIcon = `<i class="fas fa-moon"></i>`;

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleBtn.innerHTML = sunIcon;
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleBtn.innerHTML = moonIcon;
            }
            if (engagementsChart && document.getElementById('dashboard-content').classList.contains('active')) {
                loadDashboardData();
            }
        };

        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        const savedTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(savedTheme);


        // --- SIDEBAR LOGIC ---
        const sidebar = document.getElementById('sidebar');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');

        hamburgerBtn.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });
        
        sidebarToggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
            document.getElementById('main-content').style.transition = 'margin-left 0.3s';
            document.getElementById('main-content').style.marginLeft = isCollapsed ? '5rem' : '16rem';
            sidebarToggleBtn.querySelector('i').className = isCollapsed ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
        });

        // Apply sidebar state on load
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            sidebar.classList.add('collapsed');
            document.getElementById('main-content').style.marginLeft = '5rem';
            sidebarToggleBtn.querySelector('i').className = 'fas fa-chevron-right';
        }


        // --- HELPER FUNCTIONS ---
        function showLoader() { loadingOverlay.classList.remove('hidden'); }
        function hideLoader() { loadingOverlay.classList.add('hidden'); }

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 p-4 rounded-lg text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        function showPage(pageId) {
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.add('active');
                const title = pageId.replace('-content', '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('page-title').textContent = title;
            } else {
                document.getElementById('dashboard-content').classList.add('active');
                document.getElementById('page-title').textContent = 'Dashboard';
            }
            if (pageId === 'social-media-content') {
                loadSocialMediaFormData();
            }
            // Close sidebar on mobile after navigation
            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        };

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-UG', { style: 'currency', currency: 'UGX' }).format(amount);
        };
        
        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            const loginSection = document.getElementById('login-section');
            const appSection = document.getElementById('app-section');
            if (user) {
                // Setup inactivity timer on login
                window.onload = resetInactivityTimer;
                document.onmousemove = resetInactivityTimer;
                document.onkeydown = resetInactivityTimer;
                document.onclick = resetInactivityTimer;

                try {
                    let userDocRef = doc(db, `apps/${appId}/users`, user.uid);
                    let userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        const pendingUserDocRef = doc(db, `apps/${appId}/users_pending`, user.email);
                        const pendingUserDoc = await getDoc(pendingUserDocRef);

                        if (pendingUserDoc.exists()) {
                            const pendingData = pendingUserDoc.data();
                            await setDoc(userDocRef, {
                                name: pendingData.name,
                                email: user.email,
                                role: pendingData.role,
                                createdAt: pendingData.createdAt
                            });
                            
                            await deleteDoc(pendingUserDocRef);
                            userDoc = await getDoc(userDocRef);
                        } else {
                             throw new Error("User document not found and no pending registration was found for this email.");
                        }
                    }

                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                    currentUserRole = currentUser.role || 'user';
                    await setupUIForUser();
                    loginSection.classList.add('hidden');
                    appSection.classList.remove('hidden');

                } catch (error) {
                     console.error("Auth state change error:", error);
                     showToast(error.message, true);
                    await signOut(auth);
                }
            } else {
                // Clear inactivity timer on logout
                clearTimeout(inactivityTimer);
                document.onmousemove = null;
                document.onkeydown = null;
                document.onclick = null;

                currentUser = null;
                currentUserRole = 'user';
                loginSection.classList.remove('hidden');
                appSection.classList.add('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginError = document.getElementById('login-error');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginError.textContent = '';
            } catch (error) {
                let errorMessage = 'An unknown error occurred.';
                switch (error.code) {
                    case 'auth/invalid-email': errorMessage = 'Please enter a valid email address.'; break;
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential': errorMessage = 'Incorrect email or password.'; break;
                    case 'auth/too-many-requests': errorMessage = 'Access temporarily disabled. Please reset password or try again later.'; break;
                    default: errorMessage = error.message; break;
                }
                loginError.textContent = errorMessage;
            } finally {
                hideLoader();
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            const email = prompt("Please enter your email address to receive a password reset link:");
            if (email) {
                showLoader();
                sendPasswordResetEmail(auth, email)
                    .then(() => showToast("Password reset email sent! Please check your inbox."))
                    .catch((error) => showToast(`Error: ${error.message}`, true))
                    .finally(hideLoader);
            }
        });

        document.getElementById('toggle-password').addEventListener('click', () => {
            const passwordInput = document.getElementById('login-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            document.getElementById('toggle-password').querySelector('i').classList.toggle('fa-eye');
            document.getElementById('toggle-password').querySelector('i').classList.toggle('fa-eye-slash');
        });


        // --- UI SETUP & DATA LOADING ---
        async function setupUIForUser() {
            document.getElementById('user-name-display').textContent = currentUser.name;
            document.getElementById('user-role-display').textContent = currentUserRole.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const nav = document.getElementById('main-nav');
            let navLinks = `
                <a href="#" data-page="dashboard-content" class="nav-link flex items-center gap-4 py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-tachometer-alt w-6 text-center"></i><span class="nav-text">Dashboard</span></a>
                <a href="#" data-page="requisitions-content" class="nav-link flex items-center gap-4 py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-file-invoice w-6 text-center"></i><span class="nav-text">Requisitions</span></a>
                <a href="#" data-page="chat-content" class="nav-link flex items-center gap-4 py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-comments w-6 text-center"></i><span class="nav-text">Chat Room</span></a>
            `;

            if (['admin', 'president'].includes(currentUserRole)) {
                 navLinks += `<a href="#" data-page="player-registration-content" class="nav-link flex items-center gap-4 py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-user-plus w-6 text-center"></i><span class="nav-text">Player Registration</span></a>`;
            }

            if (['admin', 'treasurer', 'treasury_staff', 'president'].includes(currentUserRole)) {
                navLinks += `
                    <a href="#" data-page="finances-content" class="nav-link flex items-center gap-4 py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-coins w-6 text-center"></i><span class="nav-text">Finances</span></a>
                    <a href="#" data-page="receipts-content" class="nav-link flex items-center gap-4 py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-receipt w-6 text-center"></i><span class="nav-text">Issue Receipts</span></a>
                    <a href="#" data-page="jersey-orders-content" class="nav-link flex items-center gap-4 py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-tshirt w-6 text-center"></i><span class="nav-text">Jersey Orders</span></a>
                `;
            }
            
            const isSocialMediaManager = currentUserRole.startsWith('social_media');
            if (['admin', 'president'].includes(currentUserRole) || isSocialMediaManager) {
                navLinks += `<a href="#" data-page="social-media-content" class="nav-link flex items-center gap-4 py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-chart-line w-6 text-center"></i><span class="nav-text">Social Stats</span></a>`;
            }

            // Admin-only link at the end
             if (currentUserRole === 'admin') {
                navLinks += `<a href="#" data-page="user-management-content" class="nav-link flex items-center gap-4 py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-users-cog w-6 text-center"></i><span class="nav-text">User Management</span></a>`;
            }

            // Show admin alerts for both admin and president
             if (['admin', 'president'].includes(currentUserRole)) {
                document.getElementById('admin-alerts-section').style.display = 'block';
            } else {
                document.getElementById('admin-alerts-section').style.display = 'none';
            }
            
            nav.innerHTML = navLinks;

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(e.currentTarget.dataset.page);
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-gold', 'text-black', 'dark:text-black'));
                    e.currentTarget.classList.add('bg-gold', 'text-black', 'dark:text-black');
                });
            });
            const activeLink = document.querySelector('.nav-link[data-page="dashboard-content"]');
            if(activeLink) activeLink.classList.add('bg-gold', 'text-black', 'dark:text-black');

            // Initialize all data listeners
            loadDashboardData();
            listenForRequisitions();
            listenForChatMessages();
            listenForNotifications();

            if (['admin', 'treasurer', 'treasury_staff', 'president'].includes(currentUserRole)) {
                listenForTransactions();
                listenForPendingTransactions();
                listenForJerseyOrders();
            }

            if(['admin', 'president'].includes(currentUserRole)){
                listenForRegisteredPlayers();
            }

            if (currentUserRole === 'admin') {
                listenForUsers();
            }
            bindStaticEvents();
            setupSocialMediaPermissions();
        }

        // --- DASHBOARD ---
        function loadDashboardData() {
             const monthYear = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
            const docId = new Date().toISOString().slice(0, 7);
            const statsDocRef = doc(db, `apps/${appId}/socialMediaRates`, docId);

            onSnapshot(statsDocRef, (doc) => {
                const rawData = doc.exists() ? doc.data() : { x: 0, ig_main: 0, ig_fan: 0, whatsapp: 0, tiktok: 0 };
                const totalEngagements = Object.values(rawData).reduce((sum, val) => sum + (typeof val === 'number' ? val : 0), 0);
                const platforms = ['X', 'Instagram Main', 'Instagram Fan', 'WhatsApp', 'TikTok'];
                
                const platformKeys = {
                    'X': 'x',
                    'Instagram Main': 'ig_main',
                    'Instagram Fan': 'ig_fan',
                    'WhatsApp': 'whatsapp',
                    'TikTok': 'tiktok'
                };

                const engagementPercentages = totalEngagements > 0 
                    ? platforms.map(p => (rawData[platformKeys[p]] / totalEngagements) * 100) 
                    : [0,0,0,0,0];
                
                const ctx = document.getElementById('engagements-chart').getContext('2d');
                if (engagementsChart) engagementsChart.destroy();
                
                const isDarkMode = document.documentElement.classList.contains('dark');
                const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const textColor = isDarkMode ? '#F9FAFB' : '#1F2937';
                Chart.defaults.color = textColor;
                
                engagementsChart = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                        labels: platforms,
                        datasets: [{
                            label: `Contribution to Total Engagements for ${monthYear} (%)`,
                            data: engagementPercentages,
                            backgroundColor: [
                                'rgba(229, 231, 235, 0.8)', // X 
                                'rgba(193, 53, 132, 0.8)', // Instagram 
                                'rgba(131, 58, 180, 0.8)', // Instagram 
                                'rgba(37, 211, 102, 0.8)',  // WhatsApp
                                'rgba(255, 0, 80, 0.8)'    // TikTok
                            ],
                            borderColor: '#333',
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        indexAxis: 'y', 
                        responsive: true,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: ${c.parsed.x.toFixed(2)}%` }}},
                        scales: { 
                            x: { beginAtZero: true, grid: { color: gridColor }, ticks: { callback: (v) => v + '%' }},
                            y: { grid: { display: false }}
                        } 
                    }
                });
            });
        };
        
        // Simplified event listener
        document.getElementById('send-alert-btn').addEventListener('click', async () => {
            const message = document.getElementById('alert-message').value;
            if (!message.trim()) return;
            try {
                await addDoc(collection(db, `apps/${appId}/chat`), {
                    text: message,
                    senderName: `${currentUser.name} (Admin Alert)`,
                    senderId: currentUser.uid,
                    timestamp: Timestamp.now(),
                    isAlert: true
                });
                document.getElementById('alert-message').value = '';
                showToast("Alert sent successfully!");
            } catch (error) { showToast("Failed to send alert.", true); }
        });


        // --- EVENT BINDING ---
        function bindStaticEvents() {
            document.getElementById('new-requisition-btn').onclick = () => document.getElementById('new-requisition-form-container').classList.toggle('hidden');
            document.getElementById('add-req-item-btn').onclick = () => {
                const container = document.getElementById('req-items-container');
                const newItem = document.createElement('div');
                newItem.className = 'flex gap-2 mb-2 items-center';
                newItem.innerHTML = `
                    <input type="text" placeholder="Item Description" class="w-1/2 p-2 bg-input rounded req-item-desc" required>
                    <input type="number" placeholder="Qty" class="w-1/6 p-2 bg-input rounded req-item-qty" required min="1">
                    <input type="number" placeholder="Unit Price" class="w-1/4 p-2 bg-input rounded req-item-price" required min="0">
                    <button type="button" class="text-red-500 remove-req-item-btn"><i class="fas fa-times-circle"></i></button>`;
                container.appendChild(newItem);
            };
            document.getElementById('req-items-container').addEventListener('click', e => {
                if (e.target.closest('.remove-req-item-btn')) e.target.closest('.flex').remove();
            });

            // Bind all form submissions
            document.getElementById('requisition-form').onsubmit = handleRequisitionSubmit;
            document.getElementById('transaction-form').onsubmit = handleTransactionSubmit;
            document.getElementById('receipt-form').onsubmit = handleReceiptSubmit;
            document.getElementById('chat-form').onsubmit = handleChatSubmit;
            document.getElementById('add-user-form').onsubmit = handleAddUserSubmit;
            document.getElementById('social-media-form').onsubmit = handleSocialMediaSubmit;
            document.getElementById('jersey-order-form').onsubmit = handleJerseyOrderSubmit;
            document.getElementById('player-registration-form').onsubmit = handlePlayerRegistrationSubmit;
        }

        // --- MODULE LOGIC (Abbreviated for brevity) ---
        
        async function handleRequisitionSubmit(e) { /* ... same as before ... */ }
        function listenForRequisitions() { /* ... same as before ... */ }
        document.getElementById('requisitions-list').addEventListener('click', async (e) => { /* ... same as before ... */ });

        async function createAutomatedTransaction(description, amount, type) {
            if (!['admin', 'treasurer'].includes(currentUserRole)) {
                // For automated entries, we can bypass the approval for simplicity or enforce it
                // For now, let's auto-approve them.
                 await addDoc(collection(db, `apps/${appId}/transactions`), {
                    description,
                    amount,
                    type,
                    status: 'approved',
                    submittedBy: currentUser.name,
                    submittedAt: Timestamp.now(),
                    approvedBy: 'System',
                    approvedAt: Timestamp.now(),
                });
            } else {
                 // If a treasurer does it, it still needs approval if we want a strict workflow
                // For now, let's just add it as pending for president's review
                 await addDoc(collection(db, `apps/${appId}/transactions`), {
                    description,
                    amount,
                    type,
                    status: 'pending',
                    submittedBy: currentUser.name,
                    submittedAt: Timestamp.now(),
                });
                await createNotification(`New transaction "${description}" needs your approval.`, ['president']);
            }
        }

        async function handleTransactionSubmit(e) {
            e.preventDefault();
            showLoader();
            try {
                const description = document.getElementById('trans-desc').value;
                await addDoc(collection(db, `apps/${appId}/transactions`), {
                    description: description,
                    amount: parseFloat(document.getElementById('trans-amount').value),
                    type: document.getElementById('trans-type').value,
                    status: 'pending',
                    submittedBy: currentUser.name,
                    submittedAt: Timestamp.now(),
                });
                await createNotification(`New transaction "${description}" needs your approval.`, ['president']);
                showToast("Transaction submitted for approval!");
                e.target.reset();
            } catch (error) {
                console.error("Error submitting transaction:", error);
                showToast("Failed to submit transaction.", true);
            } finally {
                hideLoader();
            }
        }

        function listenForTransactions() {
            const q = query(collection(db, `apps/${appId}/transactions`), where('status', '==', 'approved'), orderBy('approvedAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('transactions-list');
                listEl.innerHTML = '';
                let totalCredit = 0;
                let totalDebit = 0;
                if(snapshot.empty) {
                    listEl.innerHTML = '<p class="p-4 text-center">No approved transactions found.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const trans = doc.data();
                        if(trans.type === 'credit') totalCredit += trans.amount;
                        else totalDebit += trans.amount;
                        listEl.innerHTML += `
                            <div class="grid grid-cols-4 gap-4 p-2 border-b border-theme">
                                <span>${trans.approvedAt.toDate().toLocaleDateString()}</span>
                                <span>${trans.description}</span>
                                <span class="${trans.type === 'credit' ? 'text-green-500' : 'text-red-500'}">${formatCurrency(trans.amount)}</span>
                                <span class="text-sm text-gray-500 dark:text-gray-400">Approved by ${trans.approvedBy}</span>
                            </div>
                        `;
                    });
                }
                document.getElementById('total-inflow').textContent = formatCurrency(totalCredit);
                document.getElementById('total-outflow').textContent = formatCurrency(totalDebit);
            });
        }
        
        function listenForPendingTransactions() {
             if(!['admin', 'president'].includes(currentUserRole)) {
                document.getElementById('pending-transactions-section').style.display = 'none';
                return;
            }
            document.getElementById('pending-transactions-section').style.display = 'block';
            const q = query(collection(db, `apps/${appId}/transactions`), where('status', '==', 'pending'), orderBy('submittedAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('pending-transactions-list');
                listEl.innerHTML = '';
                 if(snapshot.empty) {
                    listEl.innerHTML = '<p class="p-4 text-center">No pending transactions.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const trans = {id: doc.id, ...doc.data()};
                        listEl.innerHTML += `
                            <div class="bg-card p-3 rounded-lg border border-theme flex justify-between items-center">
                                <div>
                                    <p>${trans.description} - <span class="${trans.type === 'credit' ? 'text-green-500' : 'text-red-500'}">${formatCurrency(trans.amount)}</span></p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Submitted by ${trans.submittedBy} on ${trans.submittedAt.toDate().toLocaleDateString()}</p>
                                </div>
                                <div>
                                    <button class="approve-trans-btn bg-green-600 text-white py-1 px-3 rounded hover:bg-green-700" data-id="${trans.id}">Approve</button>
                                    <button class="reject-trans-btn bg-red-600 text-white py-1 px-3 rounded hover:bg-red-700 ml-2" data-id="${trans.id}">Reject</button>
                                </div>
                            </div>
                        `;
                    });
                }
            });
        }
        
        document.getElementById('pending-transactions-list').addEventListener('click', async e => {
            const btn = e.target;
            const id = btn.dataset.id;
            if(!id) return;
            
            let status;
            if(btn.classList.contains('approve-trans-btn')) status = 'approved';
            if(btn.classList.contains('reject-trans-btn')) status = 'rejected';
            
            if(status) {
                showLoader();
                try {
                    await updateDoc(doc(db, `apps/${appId}/transactions`, id), {
                        status: status,
                        approvedBy: currentUser.name,
                        approvedAt: Timestamp.now()
                    });
                    showToast(`Transaction ${status}.`);
                } catch(error) {
                    showToast('Failed to update transaction.', true);
                } finally {
                    hideLoader();
                }
            }
        });

        async function getNextReceiptNumber() { /* ... same as before ... */ }
        async function handleReceiptSubmit(e) {
             e.preventDefault();
            showLoader();
            try {
                const receiptNumber = await getNextReceiptNumber();
                const payerName = document.getElementById('payer-name').value;
                const payerEmail = document.getElementById('payer-email').value;
                const amount = parseFloat(document.getElementById('payment-amount').value);
                const purpose = document.getElementById('payment-purpose').value;
                // ... (rest of the logic)

                // Auto-create financial transaction
                await createAutomatedTransaction(`Receipt #${receiptNumber}: ${purpose}`, amount, 'credit');
                // ... (email logic)

            } catch(error) {
                // ...
            } finally {
                hideLoader();
            }
        }
        
        async function handleChatSubmit(e) { /* ... same as before ... */ }
        function listenForChatMessages() { /* ... same as before ... */ }
        
        async function handleAddUserSubmit(e) { /* ... same as before ... */ }
        function listenForUsers() { /* ... same as before ... */ }
        
        function setupSocialMediaPermissions() { /* ... same as before ... */ }
        async function handleSocialMediaSubmit(e) { /* ... same as before ... */ }
        function loadSocialMediaFormData() { /* ... same as before ... */ }
        
        async function getNextOrderNumber() { /* ... same as before ... */ }
        async function handleJerseyOrderSubmit(e) { /* ... same as before ... */ }
        function listenForJerseyOrders() { /* ... same as before ... */ }
        document.getElementById('jersey-orders-list').addEventListener('change', async (e) => {
            if(e.target.classList.contains('order-status-select')){
                const orderId = e.target.dataset.id;
                const newStatus = e.target.value;
                 if (newStatus === 'Paid') {
                    const orderDoc = await getDoc(doc(db, `apps/${appId}/jerseyOrders`, orderId));
                    if(orderDoc.exists()){
                        const orderData = orderDoc.data();
                        await createAutomatedTransaction(`Jersey Sale: #${orderData.orderNumber}`, JERSEY_PRICE, 'credit');
                    }
                }
                // ... (rest of the logic)
            }
        });

        // PLAYER REGISTRATION (REVISED)
        async function getNextPlayerId() { /* ... same as before ... */ }
        async function handlePlayerRegistrationSubmit(e) { /* ... same as before ... */ }
        function listenForRegisteredPlayers() { /* ... same as before ... */ }
        document.getElementById('players-list').addEventListener('change', async (e) => { /* ... same as before ... */ });

        // NOTIFICATIONS
        async function createNotification(message, roles) { /* ... same as before ... */ }
        function listenForNotifications() { /* ... same as before ... */ }

    </script>

</body></html>

