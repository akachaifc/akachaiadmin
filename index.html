<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKACHAI ADMIN PORTAL</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- EmailJS for sending emails -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF-AutoTable for tables in PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">


    <style>
        /* Custom Styles for Gold & Black Theme */
        :root {
            --bg-color: #121212;
            --primary-color: #D4AF37; /* Gold */
            --text-color: #E0E0E0;
            --card-bg: #1E1E1E;
            --border-color: #333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
        }

        .gold-text { color: var(--primary-color); }
        .bg-card { background-color: var(--card-bg); }
        .border-gold { border-color: var(--primary-color); }
        .bg-gold { background-color: var(--primary-color); }
        .hover-bg-gold-dark:hover { background-color: #b89b31; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--card-bg); }
        ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #b89b31; }

        /* Hide sections by default */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        /* Spinner */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
        <div class="loader"></div>
    </div>

    <!-- Login Section -->
    <section id="login-section" class="flex items-center justify-center min-h-screen">
        <div class="bg-card p-8 rounded-lg shadow-lg w-full max-w-md border border-gray-700">
             <img src="https://i.ibb.co/x8KnbRxQ/1000324643-92de31910003d42fc3ade892f8059b77-8-7-2025-1-30-00-PM-removebg-preview.png" alt="AKACHAI FC Logo" class="h-20 w-20 mx-auto mb-4 object-contain">
            <h1 class="text-3xl font-bold text-center gold-text mb-6">AKACHAI ADMIN PORTAL</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gold" required>
                </div>
                <div class="mb-4 relative">
                    <label for="password" class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="login-password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gold pr-10" required>
                    <span id="toggle-password" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-400" style="top: 1.875rem;">
                        <i class="fas fa-eye"></i>
                    </span>
                </div>
                 <div class="text-right mb-6">
                    <a href="#" id="forgot-password-link" class="text-sm text-yellow-400 hover:text-yellow-200 hover:underline">Forgot Password?</a>
                </div>
                <button type="submit" class="w-full bg-gold text-black font-bold py-3 rounded-md hover-bg-gold-dark transition-colors">Login</button>
            </form>
            <p id="login-error" class="text-red-500 text-center mt-4"></p>
        </div>
    </section>

    <!-- Main App Section -->
    <main id="app-section" class="hidden">
        <div class="flex h-screen">
            <!-- Sidebar Navigation -->
            <aside class="w-64 bg-card flex-shrink-0 p-4 border-r border-gray-700 flex flex-col">
                <div class="text-center mb-8">
                    <img src="https://i.ibb.co/x8KnbRxQ/1000324643-92de31910003d42fc3ade892f8059b77-8-7-2025-1-30-00-PM-removebg-preview.png" alt="AKACHAI FC Logo" class="h-16 w-16 mx-auto mb-2 object-contain">
                    <h2 class="text-2xl font-bold gold-text">Akachai FC</h2>
                </div>
                <nav id="main-nav" class="space-y-2 flex-grow">
                    <!-- Nav links will be injected by JS based on role -->
                </nav>
                 <button id="logout-btn" class="w-full mt-auto bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </aside>

            <!-- Main Content Area -->
            <div class="flex-1 p-6 md:p-8 overflow-y-auto">
                <header class="flex justify-between items-start mb-8">
                    <h1 id="page-title" class="text-5xl font-extrabold gold-text">Dashboard</h1>
                    <div class="flex items-center gap-4">
                        <div class="relative">
                             <i class="fas fa-bell text-2xl cursor-pointer text-gray-300" id="notification-icon"></i>
                             <span id="notification-badge" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </div>
                        <div id="user-profile" class="text-right">
                            <p class="font-semibold text-lg" id="user-name-display"></p>
                            <p class="text-sm text-gray-400" id="user-role-display"></p>
                        </div>
                    </div>
                </header>

                <!-- Dashboard Content -->
                <div id="dashboard-content" class="content-section active">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-200">Monthly Social Media Engagement Rates</h2>
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <canvas id="engagements-chart"></canvas>
                    </div>
                    <div id="admin-alerts-section" class="mt-8">
                        <h2 class="text-2xl font-semibold mb-4">Send Important Alert</h2>
                        <div class="bg-card p-4 rounded-lg shadow-md border border-gray-700">
                           <textarea id="alert-message" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600" rows="3" placeholder="Type your alert message here..."></textarea>
                           <button id="send-alert-btn" class="mt-2 bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark">Send Alert</button>
                        </div>
                    </div>
                </div>

                <!-- Requisitions Content -->
                <div id="requisitions-content" class="content-section">
                    <button id="new-requisition-btn" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark mb-4">New Requisition</button>
                    <div id="new-requisition-form-container" class="bg-card p-6 rounded-lg mb-6 hidden">
                        <h3 class="text-xl font-bold mb-4">Requisition Form</h3>
                        <form id="requisition-form">
                             <input type="text" id="req-name" placeholder="Your Name" class="w-full p-2 mb-2 bg-gray-700 rounded" required>
                             <textarea id="req-reason" placeholder="Reason for Requisition" class="w-full p-2 mb-2 bg-gray-700 rounded" required></textarea>
                             <div id="req-items-container">
                                <div class="flex gap-2 mb-2 items-center">
                                    <input type="text" placeholder="Item Description" class="w-1/2 p-2 bg-gray-700 rounded req-item-desc" required>
                                    <input type="number" placeholder="Qty" class="w-1/6 p-2 bg-gray-700 rounded req-item-qty" required min="1" step="any">
                                    <input type="number" placeholder="Unit Price" class="w-1/4 p-2 bg-gray-700 rounded req-item-price" required min="0" step="any">
                                </div>
                             </div>
                             <button type="button" id="add-req-item-btn" class="text-sm bg-gray-600 py-1 px-3 rounded hover:bg-gray-500 mb-4">Add Another Item</button>
                             <button type="submit" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark">Submit Requisition</button>
                        </form>
                    </div>
                    <h2 class="text-2xl font-semibold mb-4">Requisition History & Approvals</h2>
                    <div id="requisitions-list" class="space-y-4">
                        <!-- Requisition items will be dynamically added here -->
                    </div>
                </div>

                <!-- Finances Content -->
                <div id="finances-content" class="content-section">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-card p-4 rounded-lg">
                            <h3 class="text-lg font-bold text-green-400">Total Inflow</h3>
                            <p id="total-inflow" class="text-3xl font-semibold">0.00</p>
                        </div>
                        <div class="bg-card p-4 rounded-lg">
                            <h3 class="text-lg font-bold text-red-400">Total Outflow</h3>
                            <p id="total-outflow" class="text-3xl font-semibold">0.00</p>
                        </div>
                    </div>
                     <div class="bg-card p-6 rounded-lg mb-6">
                        <h3 class="text-xl font-bold mb-4">Add New Transaction</h3>
                        <form id="transaction-form" class="flex flex-wrap gap-4 items-end">
                            <div class="flex-grow">
                                <label>Description</label>
                                <input id="trans-desc" type="text" placeholder="e.g., Ticket Sales" class="w-full p-2 bg-gray-700 rounded" required>
                            </div>
                            <div class="flex-grow">
                                <label>Amount</label>
                                <input id="trans-amount" type="number" placeholder="1000" class="w-full p-2 bg-gray-700 rounded" required min="0" step="any">
                            </div>
                            <div class="flex-grow">
                                <label>Type</label>
                                <select id="trans-type" class="w-full p-2 bg-gray-700 rounded">
                                    <option value="inflow">Inflow</option>
                                    <option value="outflow">Outflow</option>
                                </select>
                            </div>
                            <button type="submit" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark">Add</button>
                        </form>
                    </div>
                    <h2 class="text-2xl font-semibold mb-4">Transaction History</h2>
                    <div id="transactions-list" class="bg-card p-4 rounded-lg">
                       <!-- transaction items will be added here -->
                    </div>
                </div>

                <!-- Receipt Issuance Content -->
                <div id="receipts-content" class="content-section">
                    <h2 class="text-2xl font-semibold mb-4">Issue a New Receipt</h2>
                    <div class="bg-card p-6 rounded-lg">
                        <form id="receipt-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label>Payer's Name</label>
                                    <input id="payer-name" type="text" class="w-full p-2 bg-gray-700 rounded" required>
                                </div>
                                <div>
                                    <label>Payer's Email</label>
                                    <input id="payer-email" type="email" class="w-full p-2 bg-gray-700 rounded" required>
                                </div>
                                <div>
                                    <label>Amount Paid</label>
                                    <input id="payment-amount" type="number" class="w-full p-2 bg-gray-700 rounded" required min="1" step="any">
                                </div>
                                <div>
                                    <label>Payment For</label>
                                    <input id="payment-purpose" type="text" placeholder="e.g., Club Membership" class="w-full p-2 bg-gray-700 rounded" required>
                                </div>
                            </div>
                            <button type="submit" class="mt-4 bg-gold text-black font-bold py-2 px-6 rounded-md hover-bg-gold-dark">Generate & Send Receipt</button>
                        </form>
                    </div>
                </div>

                <!-- Chat Room Content -->
                <div id="chat-content" class="content-section">
                    <h2 class="text-2xl font-semibold mb-4">Club Chat Room</h2>
                    <div class="bg-card rounded-lg h-[60vh] flex flex-col">
                        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
                            <!-- Chat messages will appear here -->
                        </div>
                        <div class="p-4 border-t border-gray-700">
                            <form id="chat-form" class="flex gap-2">
                                <input id="chat-input" type="text" placeholder="Type a message..." class="flex-1 p-2 bg-gray-700 rounded" required>
                                <button type="submit" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark">Send</button>
                            </form>
                        </div>
                    </div>
                </div>

                 <!-- User Management (Admin Only) -->
                <div id="user-management-content" class="content-section">
                    <div class="bg-card p-6 rounded-lg mb-6">
                        <h3 class="text-xl font-bold mb-4">Add New User</h3>
                        <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div class="md:col-span-1">
                                <label>Full Name</label>
                                <input id="new-user-name" type="text" class="w-full p-2 bg-gray-700 rounded" required>
                            </div>
                            <div class="md:col-span-1">
                                <label>Email</label>
                                <input id="new-user-email" type="email" class="w-full p-2 bg-gray-700 rounded" required>
                            </div>
                            <div class="md:col-span-1">
                                <label>Role</label>
                                <select id="new-user-role" class="w-full p-2 bg-gray-700 rounded">
                                    <option value="user">General User</option>
                                    <option value="treasurer">Treasurer</option>
                                    <option value="president">President</option>
                                    <option value="admin">Admin</option>
                                    <option value="social_media_x">Social Media (X)</option>
                                    <option value="social_media_ig_main">Social Media (Instagram Main)</option>
                                    <option value="social_media_ig_fan">Social Media (Instagram Fan)</option>
                                    <option value="social_media_whatsapp">Social Media (WhatsApp)</option>
                                    <option value="social_media_tiktok">Social Media (TikTok)</option>
                                    <option value="treasury_staff">Treasury Staff</option>
                                </select>
                            </div>
                             <button type="submit" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark">Create User</button>
                        </form>
                        <p class="text-sm mt-2 text-gray-400">A password reset email will be sent to the new user.</p>
                    </div>
                    <h2 class="text-2xl font-semibold mb-4">Manage Users</h2>
                    <div id="users-list" class="bg-card p-4 rounded-lg">
                        <!-- User list will appear here -->
                    </div>
                </div>

                <!-- Social Media Stats Content -->
                <div id="social-media-content" class="content-section">
                    <h2 class="text-2xl font-semibold mb-4">Record Social Media Engagements for <span id="current-month-year"></span></h2>
                    <div class="bg-card p-6 rounded-lg">
                        <form id="social-media-form">
                             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                 <div class="flex items-center gap-3">
                                    <i class="fab fa-twitter text-2xl w-6 text-center"></i>
                                    <div>
                                        <label for="engagement-x" class="font-semibold">X / Twitter Engagements</label>
                                        <input id="engagement-x" type="number" class="w-full p-2 bg-gray-700 rounded disabled:bg-gray-800 disabled:cursor-not-allowed" required min="0" step="1" placeholder="e.g., 1500" disabled>
                                    </div>
                                 </div>
                                 <div class="flex items-center gap-3">
                                    <i class="fab fa-instagram text-2xl w-6 text-center"></i>
                                    <div>
                                        <label for="engagement-ig-main" class="font-semibold">Instagram Main Engagements</label>
                                        <input id="engagement-ig-main" type="number" class="w-full p-2 bg-gray-700 rounded disabled:bg-gray-800 disabled:cursor-not-allowed" required min="0" step="1" placeholder="e.g., 5500" disabled>
                                    </div>
                                 </div>
                                 <div class="flex items-center gap-3">
                                     <i class="fab fa-instagram-square text-2xl w-6 text-center"></i>
                                     <div>
                                        <label for="engagement-ig-fan" class="font-semibold">Instagram Fan Engagements</label>
                                        <input id="engagement-ig-fan" type="number" class="w-full p-2 bg-gray-700 rounded disabled:bg-gray-800 disabled:cursor-not-allowed" required min="0" step="1" placeholder="e.g., 2300" disabled>
                                     </div>
                                 </div>
                                 <div class="flex items-center gap-3">
                                     <i class="fab fa-whatsapp text-2xl w-6 text-center"></i>
                                     <div>
                                        <label for="engagement-whatsapp" class="font-semibold">WhatsApp Engagements</label>
                                        <input id="engagement-whatsapp" type="number" class="w-full p-2 bg-gray-700 rounded disabled:bg-gray-800 disabled:cursor-not-allowed" required min="0" step="1" placeholder="e.g., 800" disabled>
                                     </div>
                                 </div>
                                 <div class="flex items-center gap-3">
                                     <i class="fab fa-tiktok text-2xl w-6 text-center"></i>
                                     <div>
                                        <label for="engagement-tiktok" class="font-semibold">TikTok Engagements</label>
                                        <input id="engagement-tiktok" type="number" class="w-full p-2 bg-gray-700 rounded disabled:bg-gray-800 disabled:cursor-not-allowed" required min="0" step="1" placeholder="e.g., 4200" disabled>
                                     </div>
                                 </div>
                             </div>
                              <button type="submit" class="mt-6 bg-gold text-black font-bold py-2 px-6 rounded-md hover-bg-gold-dark">Save Monthly Data</button>
                        </form>
                    </div>
                </div>

                <!-- Jersey Orders Content -->
                <div id="jersey-orders-content" class="content-section">
                    <div class="bg-card p-6 rounded-lg mb-6">
                        <h3 class="text-xl font-bold mb-4">Add New Jersey Order</h3>
                        <form id="jersey-order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            <div>
                                <label>Customer Name</label>
                                <input id="customer-name" type="text" class="w-full p-2 bg-gray-700 rounded" required>
                            </div>
                            <div>
                                <label>Customer Email</label>
                                <input id="customer-email" type="email" class="w-full p-2 bg-gray-700 rounded" required>
                            </div>
                            <div>
                                <label>Phone Number</label>
                                <input id="customer-phone" type="tel" class="w-full p-2 bg-gray-700 rounded" required>
                            </div>
                             <div>
                                <label>Jersey Size</label>
                                <select id="jersey-size" class="w-full p-2 bg-gray-700 rounded">
                                    <option>Small</option>
                                    <option>Medium</option>
                                    <option>Large</option>
                                    <option>XL</option>
                                    <option>XXL</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label>Delivery Location</label>
                                <input id="delivery-location" type="text" class="w-full p-2 bg-gray-700 rounded" required placeholder="e.g., Club House, Main Gate">
                            </div>
                             <button type="submit" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark md:col-span-2">Place Order & Send Confirmation</button>
                        </form>
                    </div>
                    <h2 class="text-2xl font-semibold mb-4">Manage Jersey Orders</h2>
                    <div id="jersey-orders-list" class="bg-card p-4 rounded-lg">
                        <!-- Jersey orders will be dynamically added here -->
                    </div>
                </div>

                <!-- Player Registration Content -->
                <div id="player-registration-content" class="content-section">
                    <div class="bg-card p-6 rounded-lg mb-6">
                        <h3 class="text-xl font-bold mb-4">Register New Player</h3>
                        <form id="player-registration-form">
                            <!-- Player Details -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label>Player's Full Name</label>
                                    <input id="player-name" type="text" class="w-full p-2 bg-gray-700 rounded" required>
                                </div>
                                <div>
                                    <label>Date of Birth</label>
                                    <input id="player-dob" type="date" class="w-full p-2 bg-gray-700 rounded" required>
                                </div>
                                <div>
                                    <label>Nationality</label>
                                    <input id="player-nationality" type="text" class="w-full p-2 bg-gray-700 rounded" required>
                                </div>
                                <div>
                                    <label>Position</label>
                                    <select id="player-position" class="w-full p-2 bg-gray-700 rounded">
                                        <option>Goalkeeper</option>
                                        <option>Defender</option>
                                        <option>Midfielder</option>
                                        <option>Forward</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Jersey Number</label>
                                    <input id="player-jersey" type="number" class="w-full p-2 bg-gray-700 rounded" min="1" max="99" required>
                                </div>
                            </div>
                            <!-- Guardian Details -->
                            <h4 class="text-lg font-semibold mb-2 border-t border-gray-700 pt-4">Guardian / Next of Kin</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label>Full Name</label>
                                    <input id="guardian-name" type="text" class="w-full p-2 bg-gray-700 rounded" required>
                                </div>
                                <div>
                                    <label>Relationship</label>
                                    <input id="guardian-relationship" type="text" class="w-full p-2 bg-gray-700 rounded" required>
                                </div>
                                <div>
                                    <label>Contact Number</label>
                                    <input id="guardian-phone" type="tel" class="w-full p-2 bg-gray-700 rounded" required>
                                </div>
                            </div>
                            <button type="submit" class="mt-6 bg-gold text-black font-bold py-2 px-6 rounded-md hover-bg-gold-dark">Add Player</button>
                        </form>
                    </div>
                    <h2 class="text-2xl font-semibold mb-4">Registered Players List</h2>
                    <div id="players-list" class="bg-card p-4 rounded-lg">
                        <!-- Player list will be dynamically added here -->
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            sendPasswordResetEmail,
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc,
            setDoc, 
            getDoc, 
            getDocs,
            updateDoc,
            deleteDoc,
            onSnapshot,
            query,
            orderBy,
            Timestamp,
            where,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- PLACEHOLDERS & CONFIG ---
        // Your actual Firebase config object.
        const providedFirebaseConfig = {
           apiKey: "AIzaSyCX1fbImBBmjz1nbVuwgAwWoQJRhP_eqFs",
           authDomain: "akachai-fc-records.firebaseapp.com",
           projectId: "akachai-fc-records",
           storageBucket: "akachai-fc-records.appspot.com",
           messagingSenderId: "368803590661",
           appId: "1:368803590661:web:ca7d0597f22e6bd40de26c"
        };
        // This logic allows the app to use injected credentials if available, otherwise it falls back to your provided config.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : providedFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'akachai-fc-portal';

        // --- EMAILJS CONFIG: Your actual credentials ---
        const EMAILJS_SERVICE_ID = "service_9nzfwtm";
        const EMAILJS_MASTER_TEMPLATE_ID = "template_2uv7tei"; // Use one ID for all emails
        const EMAILJS_NEW_USER_TEMPLATE_ID = "template_lu4axsh"; 
        const EMAILJS_PUBLIC_KEY = "l3bB3ofE87AW5cFb2";


        // --- FIREBASE INITIALIZATION ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
            emailjs.init(EMAILJS_PUBLIC_KEY);
        } catch (error)
        {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="text-red-500 text-center p-8">Failed to initialize application services. Please check configuration and console. Error: ${error.message}</div>`;
        }

        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentUserRole = 'user';
        let engagementsChart = null;
        
        // --- UI ELEMENTS ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginSection = document.getElementById('login-section');
        const appSection = document.getElementById('app-section');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');

        // --- HELPER FUNCTIONS ---
        const showLoader = () => loadingOverlay.classList.remove('hidden');
        const hideLoader = () => loadingOverlay.classList.add('hidden');

        const showToast = (message, isError = false) => {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 p-4 rounded-lg text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        const showPage = (pageId) => {
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.add('active');
                const title = pageId.replace('-content', '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('page-title').textContent = title;
            } else {
                document.getElementById('dashboard-content').classList.add('active');
                document.getElementById('page-title').textContent = 'Dashboard';
            }
            // Load social media form data if navigating to that page
            if (pageId === 'social-media-content') {
                loadSocialMediaFormData();
            }
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-UG', { style: 'currency', currency: 'UGX' }).format(amount);
        };
        
        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    let userDocRef = doc(db, `apps/${appId}/users`, user.uid);
                    let userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        const pendingUserDocRef = doc(db, `apps/${appId}/users_pending`, user.email);
                        const pendingUserDoc = await getDoc(pendingUserDocRef);

                        if (pendingUserDoc.exists()) {
                            const pendingData = pendingUserDoc.data();
                            await setDoc(userDocRef, {
                                name: pendingData.name,
                                email: user.email,
                                role: pendingData.role,
                                createdAt: pendingData.createdAt
                            });
                            
                            await deleteDoc(pendingUserDocRef);
                            userDoc = await getDoc(userDocRef);
                        } else {
                             throw new Error("User document not found and no pending registration was found for this email.");
                        }
                    }

                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                    currentUserRole = currentUser.role || 'user';
                    await setupUIForUser();
                    loginSection.classList.add('hidden');
                    appSection.classList.remove('hidden');

                } catch (error) {
                     console.error("Auth state change error:", error);
                     showToast(error.message, true);
                    await signOut(auth);
                }
            } else {
                currentUser = null;
                currentUserRole = 'user';
                loginSection.classList.remove('hidden');
                appSection.classList.add('hidden');
            }
        });


        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginError.textContent = '';
            } catch (error) {
                let errorMessage = 'An unknown error occurred.';
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage = 'Please enter a valid email address.';
                        break;
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        errorMessage = 'Incorrect email or password. Please try again.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Access temporarily disabled due to too many failed login attempts. Please reset your password or try again later.';
                        break;
                    default:
                        errorMessage = error.message;
                        break;
                }
                loginError.textContent = errorMessage;
            } finally {
                hideLoader();
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            const email = prompt("Please enter your email address to receive a password reset link:");
            if (email) {
                showLoader();
                sendPasswordResetEmail(auth, email)
                    .then(() => {
                        hideLoader();
                        showToast("Password reset email sent! Please check your inbox.");
                    })
                    .catch((error) => {
                        hideLoader();
                        showToast(`Error: ${error.message}`, true);
                    });
            }
        });

        const togglePassword = document.getElementById('toggle-password');
        const passwordInput = document.getElementById('login-password');
        togglePassword.addEventListener('click', () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            togglePassword.querySelector('i').classList.toggle('fa-eye');
            togglePassword.querySelector('i').classList.toggle('fa-eye-slash');
        });


        // --- UI SETUP & DATA LOADING ---
        const setupUIForUser = async () => {
            document.getElementById('user-name-display').textContent = currentUser.name;
            document.getElementById('user-role-display').textContent = currentUserRole.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const nav = document.getElementById('main-nav');
            let navLinks = `
                <a href="#" data-page="dashboard-content" class="nav-link block py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-tachometer-alt w-6"></i> Dashboard</a>
                <a href="#" data-page="requisitions-content" class="nav-link block py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-file-invoice w-6"></i> Requisitions</a>
                <a href="#" data-page="chat-content" class="nav-link block py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-comments w-6"></i> Chat Room</a>
            `;

            if (currentUserRole === 'admin') {
                navLinks += `<a href="#" data-page="user-management-content" class="nav-link block py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-users-cog w-6"></i> User Management</a>`;
                document.getElementById('admin-alerts-section').style.display = 'block';
            } else {
                document.getElementById('admin-alerts-section').style.display = 'none';
            }
            
            if (['admin', 'president'].includes(currentUserRole)) {
                 navLinks += `<a href="#" data-page="player-registration-content" class="nav-link block py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-user-plus w-6"></i> Player Registration</a>`;
            }

            if (['admin', 'treasurer', 'treasury_staff', 'president'].includes(currentUserRole)) {
                navLinks += `<a href="#" data-page="finances-content" class="nav-link block py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-coins w-6"></i> Finances</a>`;
                navLinks += `<a href="#" data-page="receipts-content" class="nav-link block py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-receipt w-6"></i> Issue Receipts</a>`;
                navLinks += `<a href="#" data-page="jersey-orders-content" class="nav-link block py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-tshirt w-6"></i> Jersey Orders</a>`;
            }
            
            const isSocialMediaManager = currentUserRole.startsWith('social_media');
            if (currentUserRole === 'admin' || isSocialMediaManager) {
                navLinks += `<a href="#" data-page="social-media-content" class="nav-link block py-2 px-4 rounded hover:bg-gray-700"><i class="fas fa-chart-line w-6"></i> Social Stats</a>`;
            }
            
            nav.innerHTML = navLinks;

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(e.currentTarget.dataset.page);
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-gold', 'text-black'));
                    e.currentTarget.classList.add('bg-gold', 'text-black');
                });
            });
            document.querySelector('.nav-link[data-page="dashboard-content"]').classList.add('bg-gold', 'text-black');

            loadDashboardData();
            listenForRequisitions();
            listenForChatMessages();
            listenForNotifications();

            if (['admin', 'treasurer', 'treasury_staff', 'president'].includes(currentUserRole)) {
                listenForTransactions();
                listenForJerseyOrders();
            }

            if(['admin', 'president'].includes(currentUserRole)){
                listenForRegisteredPlayers();
            }

            if (currentUserRole === 'admin') {
                listenForUsers();
            }
            bindStaticEvents();
            setupSocialMediaPermissions();
        };

        // --- DASHBOARD ---
        const loadDashboardData = () => {
            const monthYear = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
            const docId = new Date().toISOString().slice(0, 7); // e.g., "2025-10"
            const statsDocRef = doc(db, `apps/${appId}/socialMediaRates`, docId);

            onSnapshot(statsDocRef, (doc) => {
                const rawData = doc.exists() ? doc.data() : { x: 0, ig_main: 0, ig_fan: 0, whatsapp: 0, tiktok: 0 };
                
                const totalEngagements = Object.values(rawData).reduce((sum, val) => sum + (typeof val === 'number' ? val : 0), 0);

                if(!doc.exists()){
                    console.warn(`No social media data found for ${monthYear}. Displaying zeros. Please update data on the Social Stats page.`);
                }

                const platforms = ['X', 'Instagram Main', 'Instagram Fan', 'WhatsApp', 'TikTok'];
                // Calculate percentage of total for the graph
                const engagementPercentages = totalEngagements > 0 ? [
                    (rawData.x / totalEngagements) * 100,
                    (rawData.ig_main / totalEngagements) * 100,
                    (rawData.ig_fan / totalEngagements) * 100,
                    (rawData.whatsapp / totalEngagements) * 100,
                    (rawData.tiktok / totalEngagements) * 100
                ] : [0, 0, 0, 0, 0];


                const ctx = document.getElementById('engagements-chart').getContext('2d');
                if (engagementsChart) engagementsChart.destroy();
                
                Chart.defaults.color = '#9CA3AF';
                
                engagementsChart = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                        labels: platforms,
                        datasets: [{
                            label: `Contribution to Total Engagements for ${monthYear} (%)`,
                            data: engagementPercentages,
                            backgroundColor: [
                                'rgba(255, 255, 255, 0.8)', // X (White/Gray)
                                'rgba(193, 53, 132, 0.8)', // Instagram (Pink)
                                'rgba(131, 58, 180, 0.8)', // Instagram (Purple)
                                'rgba(37, 211, 102, 0.8)',  // WhatsApp (Green)
                                'rgba(255, 0, 80, 0.8)'    // TikTok (Red/Pink)
                            ],
                            borderColor: '#333',
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        indexAxis: 'y', 
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false 
                            },
                             tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.x !== null) {
                                            label += context.parsed.x.toFixed(2) + '%';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: { 
                            x: { 
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%' 
                                    }
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                }
                            }
                        } 
                    }
                });
            });
        };

        document.getElementById('send-alert-btn').addEventListener('click', async () => {
            const message = document.getElementById('alert-message').value;
            if (!message.trim()) return;
            try {
                const chatCol = collection(db, `apps/${appId}/chat`);
                await addDoc(chatCol, {
                    text: message,
                    senderName: `${currentUser.name} (Admin Alert)`,
                    senderId: currentUser.uid,
                    timestamp: Timestamp.now(),
                    isAlert: true
                });
                document.getElementById('alert-message').value = '';
                showToast("Alert sent successfully!");
            } catch (error) {
                console.error("Error sending alert:", error);
                showToast("Failed to send alert.", true);
            }
        });


        // --- EVENT BINDING ---
        function bindStaticEvents() {
            // Requisition Form
            const newReqBtn = document.getElementById('new-requisition-btn');
            const newReqFormContainer = document.getElementById('new-requisition-form-container');
            newReqBtn.onclick = () => newReqFormContainer.classList.toggle('hidden');
            
            document.getElementById('add-req-item-btn').onclick = () => {
                const container = document.getElementById('req-items-container');
                const newItem = document.createElement('div');
                newItem.className = 'flex gap-2 mb-2 items-center';
                newItem.innerHTML = `
                    <input type="text" placeholder="Item Description" class="w-1/2 p-2 bg-gray-700 rounded req-item-desc" required>
                    <input type="number" placeholder="Qty" class="w-1/6 p-2 bg-gray-700 rounded req-item-qty" required min="1" step="any">
                    <input type="number" placeholder="Unit Price" class="w-1/4 p-2 bg-gray-700 rounded req-item-price" required min="0" step="any">
                    <button type="button" class="text-red-500 remove-req-item-btn"><i class="fas fa-times-circle"></i></button>
                `;
                container.appendChild(newItem);
            };
            document.getElementById('req-items-container').addEventListener('click', e => {
                if (e.target.closest('.remove-req-item-btn')) {
                    e.target.closest('.flex').remove();
                }
            });

            document.getElementById('requisition-form').onsubmit = handleRequisitionSubmit;
            
            // Other forms
            document.getElementById('transaction-form').onsubmit = handleTransactionSubmit;
            document.getElementById('receipt-form').onsubmit = handleReceiptSubmit;
            document.getElementById('chat-form').onsubmit = handleChatSubmit;
            document.getElementById('add-user-form').onsubmit = handleAddUserSubmit;
            document.getElementById('social-media-form').onsubmit = handleSocialMediaSubmit;
            document.getElementById('jersey-order-form').onsubmit = handleJerseyOrderSubmit;
            document.getElementById('player-registration-form').onsubmit = handlePlayerRegistrationSubmit;
        }

        // --- MODULE LOGIC (Requisitions, Finances, Chat etc.) ---
        
        // REQUISITIONS
        async function handleRequisitionSubmit(e) {
            e.preventDefault();
            showLoader();
            const items = [];
            let total = 0;
            document.querySelectorAll('#req-items-container .flex').forEach(itemEl => {
                const desc = itemEl.querySelector('.req-item-desc').value;
                const qty = parseFloat(itemEl.querySelector('.req-item-qty').value);
                const price = parseFloat(itemEl.querySelector('.req-item-price').value);
                items.push({ desc, qty, price });
                total += qty * price;
            });
            
            const requisitionData = {
                requesterName: document.getElementById('req-name').value,
                requesterId: currentUser.uid,
                reason: document.getElementById('req-reason').value,
                items,
                total,
                status: 'pending', // pending -> approved -> rejected
                createdAt: Timestamp.now(),
            };
            
            try {
                const reqCol = collection(db, `apps/${appId}/requisitions`);
                await addDoc(reqCol, requisitionData);
                // Create notifications for president and treasurer
                await createNotification('New requisition submitted', ['president', 'treasurer']);
                showToast('Requisition submitted successfully!');
                e.target.reset();
                document.getElementById('new-requisition-form-container').classList.add('hidden');
            } catch (error) {
                console.error("Error submitting requisition:", error);
                showToast('Failed to submit requisition.', true);
            } finally {
                hideLoader();
            }
        }
        
        function listenForRequisitions() {
            const reqCol = collection(db, `apps/${appId}/requisitions`);
            const q = query(reqCol, orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('requisitions-list');
                listEl.innerHTML = '';
                if (snapshot.empty) {
                    listEl.innerHTML = '<p>No requisitions found.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const req = { id: doc.id, ...doc.data() };
                    const canApprove = (currentUserRole === 'president' || currentUserRole === 'treasurer') && req.status === 'pending';
                    
                    const itemHtml = req.items.map(i => `<li>${i.qty}x ${i.desc} @ ${formatCurrency(i.price)}</li>`).join('');
                    
                    const el = document.createElement('div');
                    el.className = 'bg-card p-4 rounded-lg border border-gray-700';
                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold">${req.reason}</p>
                                <p class="text-sm text-gray-400">By ${req.requesterName} on ${req.createdAt.toDate().toLocaleDateString()}</p>
                                <p class="font-bold text-lg gold-text mt-2">Total: ${formatCurrency(req.total)}</p>
                            </div>
                            <span class="px-3 py-1 text-sm rounded-full 
                                ${req.status === 'pending' ? 'bg-yellow-500 text-black' : req.status === 'approved' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
                                ${req.status}
                            </span>
                        </div>
                        <ul class="list-disc list-inside mt-2 text-gray-300">${itemHtml}</ul>
                        ${canApprove ? `
                        <div class="mt-4 flex gap-2">
                            <button class="approve-req-btn bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded" data-id="${req.id}">Approve</button>
                            <button class="reject-req-btn bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded" data-id="${req.id}">Reject</button>
                        </div>
                        ` : ''}
                    `;
                    listEl.appendChild(el);
                });
            });
        }
        document.getElementById('requisitions-list').addEventListener('click', async (e) => {
            const button = e.target;
            const reqId = button.dataset.id;
            if (!reqId) return;

            let newStatus = '';
            if (button.classList.contains('approve-req-btn')) newStatus = 'approved';
            if (button.classList.contains('reject-req-btn')) newStatus = 'rejected';
            
            if(newStatus){
                showLoader();
                try {
                    const reqDocRef = doc(db, `apps/${appId}/requisitions`, reqId);
                    await updateDoc(reqDocRef, { status: newStatus });
                    showToast(`Requisition ${newStatus}.`);
                } catch(error) {
                    console.error("Error updating requisition:", error);
                    showToast('Update failed.', true);
                } finally {
                    hideLoader();
                }
            }
        });

        // FINANCES
        async function handleTransactionSubmit(e) {
            e.preventDefault();
            showLoader();
            const transaction = {
                description: document.getElementById('trans-desc').value,
                amount: parseFloat(document.getElementById('trans-amount').value),
                type: document.getElementById('trans-type').value,
                addedBy: currentUser.name,
                createdAt: Timestamp.now(),
            };
            try {
                await addDoc(collection(db, `apps/${appId}/transactions`), transaction);
                showToast('Transaction added!');
                e.target.reset();
            } catch (error) {
                console.error("Error adding transaction:", error);
                showToast('Failed to add transaction.', true);
            } finally {
                hideLoader();
            }
        }

        function listenForTransactions() {
            const transCol = collection(db, `apps/${appId}/transactions`);
            const q = query(transCol, orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('transactions-list');
                listEl.innerHTML = '';
                let totalInflow = 0;
                let totalOutflow = 0;
                if(snapshot.empty){
                    listEl.innerHTML = '<p>No transactions found.</p>';
                }
                snapshot.forEach(doc => {
                    const trans = doc.data();
                    if(trans.type === 'inflow') totalInflow += trans.amount;
                    else totalOutflow += trans.amount;

                    const el = document.createElement('div');
                    el.className = `flex justify-between items-center p-2 border-b border-gray-700 ${trans.type === 'inflow' ? 'text-green-400' : 'text-red-400'}`;
                    el.innerHTML = `
                        <div>
                            <p>${trans.description}</p>
                            <p class="text-xs text-gray-500">${trans.createdAt.toDate().toLocaleString()}</p>
                        </div>
                        <p class="font-bold">${formatCurrency(trans.amount)}</p>
                    `;
                    listEl.appendChild(el);
                });
                document.getElementById('total-inflow').textContent = formatCurrency(totalInflow);
                document.getElementById('total-outflow').textContent = formatCurrency(totalOutflow);
            });
        }

        // RECEIPTS
        async function getNextReceiptNumber() {
            const counterRef = doc(db, `apps/${appId}/counters`, 'receiptCounter');
            let newReceiptNumber;
            await runTransaction(db, async (transaction) => {
                const counterDoc = await transaction.get(counterRef);
                if (!counterDoc.exists()) {
                    newReceiptNumber = 1;
                    transaction.set(counterRef, { currentNumber: newReceiptNumber });
                } else {
                    newReceiptNumber = counterDoc.data().currentNumber + 1;
                    transaction.update(counterRef, { currentNumber: newReceiptNumber });
                }
            });
            return `AFC-REC-${String(newReceiptNumber).padStart(4, '0')}`;
        }

        async function handleReceiptSubmit(e) {
            e.preventDefault();
            showLoader();
            const payerName = document.getElementById('payer-name').value;
            const payerEmail = document.getElementById('payer-email').value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const purpose = document.getElementById('payment-purpose').value;

            try {
                const receiptNumber = await getNextReceiptNumber();
                const securityCode = `SEC-${crypto.randomUUID()}`;

                const qr = qrcode(0, 'L');
                qr.addData(securityCode);
                qr.make();
                const qrImgData = qr.createDataURL(4);

                await addDoc(collection(db, `apps/${appId}/receipts`), {
                    receiptNumber, securityCode, payerName, payerEmail, amount, purpose, createdAt: Timestamp.now()
                });

                const templateParams = {
                    subject_line: `Your Akachai FC Receipt #${receiptNumber}`,
                    email_title: "OFFICIAL RECEIPT",
                    to_name: payerName,
                    to_email: payerEmail,
                    is_receipt: true,
                    is_order_confirmation: false,
                    is_pickup_notification: false,
                    receipt_number: receiptNumber,
                    amount: formatCurrency(amount),
                    purpose: purpose,
                    receipt_date: new Date().toLocaleDateString(),
                    qr_code_image: qrImgData
                };

                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_MASTER_TEMPLATE_ID, templateParams);

                showToast(`Receipt sent successfully! #: ${receiptNumber}`);
                e.target.reset();

            } catch (error) {
                console.error("Receipt sending failed:", error);
                showToast("Failed to send receipt. Check console for details.", true);
            } finally {
                hideLoader();
            }
        }
        
        // CHAT
        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const messageText = input.value.trim();
            if (!messageText) return;
            
            try {
                await addDoc(collection(db, `apps/${appId}/chat`), {
                    text: messageText,
                    senderName: currentUser.name,
                    senderId: currentUser.uid,
                    timestamp: Timestamp.now()
                });
                input.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showToast('Could not send message.', true);
            }
        }
        
        function listenForChatMessages() {
            const chatCol = collection(db, `apps/${appId}/chat`);
            const q = query(chatCol, orderBy('timestamp', 'asc'));
            onSnapshot(q, (snapshot) => {
                const messagesEl = document.getElementById('chat-messages');
                messagesEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.senderId === currentUser.uid;
                    const el = document.createElement('div');
                    el.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
                    const bgColor = msg.isAlert ? 'bg-red-800' : isMe ? 'bg-gold text-black' : 'bg-gray-600';
                    el.innerHTML = `
                        <div class="text-xs text-gray-400 mb-1 ${isMe ? 'mr-2' : 'ml-2'}">${msg.senderName}</div>
                        <div class="max-w-xs md:max-w-md p-3 rounded-lg ${bgColor}">
                           <p>${msg.text}</p>
                        </div>
                    `;
                    messagesEl.appendChild(el);
                });
                messagesEl.scrollTop = messagesEl.scrollHeight;
            });
        }
        
        // USER MANAGEMENT (Admin)
        async function handleAddUserSubmit(e) {
            e.preventDefault();
            showLoader();
            const name = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const role = document.getElementById('new-user-role').value;
            
            try {
                // This doesn't create an auth user, but sends a link they can use to sign up.
                // The actual user creation happens on their first login.
                await sendPasswordResetEmail(auth, email);
                
                // We store their info in a pending collection.
                await setDoc(doc(db, `apps/${appId}/users_pending`, email), {
                    name, email, role, createdAt: Timestamp.now()
                });
                
                showToast('Password reset/invitation email sent to new user.');
                e.target.reset();

            } catch (error) {
                console.error("Error adding user:", error);
                showToast(error.message, true);
            } finally {
                hideLoader();
            }
        }

        function listenForUsers() {
             const usersCol = collection(db, `apps/${appId}/users`);
             onSnapshot(usersCol, (snapshot) => {
                 const listEl = document.getElementById('users-list');
                 listEl.innerHTML = '';
                 snapshot.forEach(doc => {
                     const user = doc.data();
                     const el = document.createElement('div');
                     el.className = 'flex justify-between items-center p-2 border-b border-gray-700';
                     el.innerHTML = `
                        <div>
                            <p class="font-bold">${user.name}</p>
                            <p class="text-sm text-gray-400">${user.email} - ${user.role}</p>
                        </div>
                        <button class="text-red-500 delete-user-btn" data-id="${doc.id}"><i class="fas fa-trash"></i></button>
                     `;
                     listEl.appendChild(el);
                 });
             });
         }
        
        function setupSocialMediaPermissions() {
            const form = document.getElementById('social-media-form');
            const inputs = {
                x: form.querySelector('#engagement-x'),
                ig_main: form.querySelector('#engagement-ig-main'),
                ig_fan: form.querySelector('#engagement-ig-fan'),
                whatsapp: form.querySelector('#engagement-whatsapp'),
                tiktok: form.querySelector('#engagement-tiktok'),
            };

            // Disable all by default (already done in HTML, but good practice)
            Object.values(inputs).forEach(input => input.disabled = true);

            // Enable inputs based on role
            if (currentUserRole === 'admin') {
                Object.values(inputs).forEach(input => input.disabled = false);
            } else {
                switch (currentUserRole) {
                    case 'social_media_x':
                        inputs.x.disabled = false;
                        break;
                    case 'social_media_ig_main':
                        inputs.ig_main.disabled = false;
                        break;
                    case 'social_media_ig_fan':
                        inputs.ig_fan.disabled = false;
                        break;
                    case 'social_media_whatsapp':
                        inputs.whatsapp.disabled = false;
                        break;
                    case 'social_media_tiktok':
                        inputs.tiktok.disabled = false;
                        break;
                }
            }
        }
 
        // SOCIAL MEDIA
        async function handleSocialMediaSubmit(e) {
            e.preventDefault();
            showLoader();
            const docId = new Date().toISOString().slice(0, 7); // e.g., "2025-10"
            const docRef = doc(db, `apps/${appId}/socialMediaRates`, docId);

            try {
                // Fetch existing data first to prevent overwriting other platforms' stats
                const docSnap = await getDoc(docRef);
                const existingData = docSnap.exists() ? docSnap.data() : {};

                const updates = {};

                // Determine which fields to update based on user role
                if (currentUserRole === 'admin') {
                    updates.x = parseFloat(document.getElementById('engagement-x').value) || 0;
                    updates.ig_main = parseFloat(document.getElementById('engagement-ig-main').value) || 0;
                    updates.ig_fan = parseFloat(document.getElementById('engagement-ig-fan').value) || 0;
                    updates.whatsapp = parseFloat(document.getElementById('engagement-whatsapp').value) || 0;
                    updates.tiktok = parseFloat(document.getElementById('engagement-tiktok').value) || 0;
                } else {
                    switch (currentUserRole) {
                        case 'social_media_x':
                            updates.x = parseFloat(document.getElementById('engagement-x').value) || 0;
                            break;
                        case 'social_media_ig_main':
                            updates.ig_main = parseFloat(document.getElementById('engagement-ig-main').value) || 0;
                            break;
                        case 'social_media_ig_fan':
                            updates.ig_fan = parseFloat(document.getElementById('engagement-ig-fan').value) || 0;
                            break;
                        case 'social_media_whatsapp':
                            updates.whatsapp = parseFloat(document.getElementById('engagement-whatsapp').value) || 0;
                            break;
                        case 'social_media_tiktok':
                            updates.tiktok = parseFloat(document.getElementById('engagement-tiktok').value) || 0;
                            break;
                    }
                }

                const finalData = {
                    ...existingData,
                    ...updates,
                    lastUpdatedBy: currentUser.name,
                    lastUpdatedAt: Timestamp.now()
                };

                await setDoc(docRef, finalData);
                showToast('Monthly engagement data saved!');
            } catch (error) {
                console.error("Error saving stats:", error);
                showToast('Failed to save data.', true);
            } finally {
                hideLoader();
            }
        }
        
        function loadSocialMediaFormData() {
            const monthYear = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
            document.getElementById('current-month-year').textContent = monthYear;

            const docId = new Date().toISOString().slice(0, 7);
            const statsDocRef = doc(db, `apps/${appId}/socialMediaRates`, docId);
            
            getDoc(statsDocRef).then(doc => {
                if (doc.exists()) {
                    const data = doc.data();
                    document.getElementById('engagement-x').value = data.x || '';
                    document.getElementById('engagement-ig-main').value = data.ig_main || '';
                    document.getElementById('engagement-ig-fan').value = data.ig_fan || '';
                    document.getElementById('engagement-whatsapp').value = data.whatsapp || '';
                    document.getElementById('engagement-tiktok').value = data.tiktok || '';
                } else {
                    // Clear form if no data for the current month
                    document.getElementById('social-media-form').reset();
                }
            });
        }
        
        // JERSEY ORDERS
        async function getNextOrderNumber() {
            const counterRef = doc(db, `apps/${appId}/counters`, 'jerseyOrderCounter');
            let newOrderNumber;
            await runTransaction(db, async (transaction) => {
                const counterDoc = await transaction.get(counterRef);
                if (!counterDoc.exists()) {
                    newOrderNumber = 1;
                    transaction.set(counterRef, { currentNumber: newOrderNumber });
                } else {
                    newOrderNumber = counterDoc.data().currentNumber + 1;
                    transaction.update(counterRef, { currentNumber: newOrderNumber });
                }
            });
            return `AFC-J-${String(newOrderNumber).padStart(4, '0')}`;
        }

        async function handleJerseyOrderSubmit(e) {
            e.preventDefault();
            showLoader();
            try {
                const orderNumber = await getNextOrderNumber();
                const customerName = document.getElementById('customer-name').value;
                const customerEmail = document.getElementById('customer-email').value;
                const customerPhone = document.getElementById('customer-phone').value;
                const jerseySize = document.getElementById('jersey-size').value;
                const deliveryLocation = document.getElementById('delivery-location').value;

                const orderData = {
                    orderNumber: orderNumber,
                    customerName: customerName,
                    customerEmail: customerEmail,
                    customerPhone: customerPhone,
                    jerseySize: jerseySize,
                    deliveryLocation: deliveryLocation,
                    status: 'Pending', // Pending -> Paid -> Ready for Pick Up
                    placedBy: currentUser.name,
                    createdAt: Timestamp.now()
                };
                
                await addDoc(collection(db, `apps/${appId}/jerseyOrders`), orderData);

                const templateParams = {
                    subject_line: `Akachai FC Jersey Order Confirmation #${orderNumber}`,
                    email_title: "ORDER CONFIRMATION",
                    to_name: customerName,
                    to_email: customerEmail,
                    is_receipt: false,
                    is_order_confirmation: true,
                    is_pickup_notification: false,
                    order_number: orderNumber,
                    jersey_size: jerseySize,
                    delivery_location: deliveryLocation
                };
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_MASTER_TEMPLATE_ID, templateParams);
                
                showToast(`Order placed and confirmation sent! Order #: ${orderNumber}`);
                e.target.reset();

            } catch (error) {
                console.error("Error placing jersey order:", error);
                showToast("Failed to place order. Please try again.", true);
            } finally {
                hideLoader();
            }
        }
        
        function listenForJerseyOrders() {
            const ordersCol = collection(db, `apps/${appId}/jerseyOrders`);
            const q = query(ordersCol, orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('jersey-orders-list');
                listEl.innerHTML = `
                    <div class="grid grid-cols-6 gap-4 font-bold p-2 border-b border-gray-600">
                        <div>Order #</div>
                        <div>Customer</div>
                        <div>Size</div>
                        <div>Delivery Location</div>
                        <div>Date</div>
                        <div>Status</div>
                    </div>
                `;
                if(snapshot.empty){
                    listEl.innerHTML += '<p class="p-4 text-center">No jersey orders found.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const order = {id: doc.id, ...doc.data()};
                    const el = document.createElement('div');
                    el.className = 'grid grid-cols-6 gap-4 items-center p-2 border-b border-gray-700';
                    el.innerHTML = `
                        <div>${order.orderNumber}</div>
                        <div>
                            <p>${order.customerName}</p>
                            <p class="text-xs text-gray-400">${order.customerPhone}</p>
                            <p class="text-xs text-gray-400">${order.customerEmail || ''}</p>
                        </div>
                        <div>${order.jerseySize}</div>
                        <div>${order.deliveryLocation}</div>
                        <div>${order.createdAt.toDate().toLocaleDateString()}</div>
                        <div>
                            <select class="order-status-select bg-gray-600 rounded p-1" data-id="${order.id}">
                                <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Paid" ${order.status === 'Paid' ? 'selected' : ''}>Paid</option>
                                <option value="Ready for Pick Up" ${order.status === 'Ready for Pick Up' ? 'selected' : ''}>Ready for Pick Up</option>
                            </select>
                        </div>
                    `;
                    listEl.appendChild(el);
                });
            });
        }
        
        document.getElementById('jersey-orders-list').addEventListener('change', async (e) => {
            if(e.target.classList.contains('order-status-select')){
                showLoader();
                const orderId = e.target.dataset.id;
                const newStatus = e.target.value;
                try {
                    const orderDocRef = doc(db, `apps/${appId}/jerseyOrders`, orderId);
                    await updateDoc(orderDocRef, { status: newStatus });
                    
                    if (newStatus === 'Ready for Pick Up') {
                        const orderDoc = await getDoc(orderDocRef);
                        if(orderDoc.exists()){
                            const orderData = orderDoc.data();
                             const templateParams = {
                                subject_line: `Your Akachai FC Order #${orderData.orderNumber} is Ready for Pick Up!`,
                                email_title: "ORDER READY FOR PICK UP",
                                to_name: orderData.customerName,
                                to_email: orderData.customerEmail,
                                is_receipt: false,
                                is_order_confirmation: false,
                                is_pickup_notification: true,
                                order_number: orderData.orderNumber,
                                delivery_location: orderData.deliveryLocation
                            };
                            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_MASTER_TEMPLATE_ID, templateParams);
                            showToast("Order status updated and 'Ready for Pick Up' confirmation sent!");
                        }
                    } else {
                        showToast("Order status updated.");
                    }

                } catch(error) {
                    console.error("Error updating order status: ", error);
                    showToast("Failed to update status.", true);
                } finally {
                    hideLoader();
                }
            }
        });

        // PLAYER REGISTRATION
        async function getNextPlayerId() {
            const counterRef = doc(db, `apps/${appId}/counters`, 'playerCounter');
            let newPlayerNumber;
            await runTransaction(db, async (transaction) => {
                const counterDoc = await transaction.get(counterRef);
                if (!counterDoc.exists()) {
                    newPlayerNumber = 1;
                    transaction.set(counterRef, { currentNumber: newPlayerNumber });
                } else {
                    newPlayerNumber = counterDoc.data().currentNumber + 1;
                    transaction.update(counterRef, { currentNumber: newPlayerNumber });
                }
            });
            return `AFC-P-${String(newPlayerNumber).padStart(4, '0')}`;
        }

        async function handlePlayerRegistrationSubmit(e) {
            e.preventDefault();
            showLoader();
            try {
                const playerId = await getNextPlayerId();

                const playerData = {
                    playerId: playerId,
                    name: document.getElementById('player-name').value,
                    dob: document.getElementById('player-dob').value,
                    nationality: document.getElementById('player-nationality').value,
                    position: document.getElementById('player-position').value,
                    jerseyNumber: document.getElementById('player-jersey').value,
                    guardian: {
                        name: document.getElementById('guardian-name').value,
                        relationship: document.getElementById('guardian-relationship').value,
                        phone: document.getElementById('guardian-phone').value,
                    },
                    registeredBy: currentUser.name,
                    createdAt: Timestamp.now()
                };

                await addDoc(collection(db, `apps/${appId}/players`), playerData);
                showToast(`Player registered successfully! ID: ${playerId}`);
                e.target.reset();

            } catch (error) {
                console.error("Error registering player:", error);
                showToast("Failed to register player.", true);
            } finally {
                hideLoader();
            }
        }

        function listenForRegisteredPlayers() {
            const playersCol = collection(db, `apps/${appId}/players`);
            const q = query(playersCol, orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('players-list');
                listEl.innerHTML = `
                    <div class="hidden md:grid grid-cols-5 gap-4 font-bold p-2 border-b border-gray-600">
                        <div>Player ID</div>
                        <div>Name</div>
                        <div>Position</div>
                        <div>Jersey #</div>
                        <div>Next of Kin</div>
                    </div>
                `;
                if(snapshot.empty){
                    listEl.innerHTML += '<p class="p-4 text-center">No players registered yet.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const player = {id: doc.id, ...doc.data()};
                    const el = document.createElement('div');
                    el.className = 'grid grid-cols-1 md:grid-cols-5 gap-4 items-center p-2 border-b border-gray-700';
                    el.innerHTML = `
                        <div>
                            <p class="font-bold md:hidden">Player ID</p>
                            ${player.playerId}
                        </div>
                        <div>
                            <p class="font-bold md:hidden">Name</p>
                            <p>${player.name}</p>
                            <p class="text-xs text-gray-400">DOB: ${player.dob}</p>
                        </div>
                        <div>
                            <p class="font-bold md:hidden">Position</p>
                            ${player.position}
                        </div>
                        <div>
                            <p class="font-bold md:hidden">Jersey #</p>
                            ${player.jerseyNumber}
                        </div>
                        <div>
                            <p class="font-bold md:hidden">Next of Kin</p>
                            <p>${player.guardian.name} (${player.guardian.relationship})</p>
                             <p class="text-xs text-gray-400">${player.guardian.phone}</p>
                        </div>
                    `;
                    listEl.appendChild(el);
                });
            });
        }

        // NOTIFICATIONS
        async function createNotification(message, roles) {
            try {
                const usersQuery = query(collection(db, `apps/${appId}/users`), where('role', 'in', roles));
                const querySnapshot = await getDocs(usersQuery);
                querySnapshot.forEach(async (userDoc) => {
                    const userId = userDoc.id;
                    await addDoc(collection(db, `apps/${appId}/users/${userId}/notifications`), {
                        message,
                        read: false,
                        createdAt: Timestamp.now()
                    });
                });
            } catch (error) {
                console.error("Error creating notification:", error);
            }
        }

        function listenForNotifications() {
            if (!currentUser) return;
            const notifCol = collection(db, `apps/${appId}/users/${currentUser.uid}/notifications`);
            const q = query(notifCol, where('read', '==', false));
            onSnapshot(q, (snapshot) => {
                const badge = document.getElementById('notification-badge');
                if (snapshot.size > 0) {
                    badge.textContent = snapshot.size;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            });
        }

        window.jsPDF = window.jspdf.jsPDF; // Make jsPDF available globally for the plugin
    </script>
</body>
</html>

